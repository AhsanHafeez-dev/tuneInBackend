
generator client {
  provider = "prisma-client-js"
  
}

datasource db {
  // only for development
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id String @id @default(uuid())
  watchHistory  WatchHistory[] 
  userName String @unique 
  email String @unique 
  fullName String 
  // avatar is compulsory for our application
  avatar String
  avatarPublicId String 
  coverImage String? 
  coverImagePublicId String?
  password String
  refreshToken String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt  
  videos Video[] 
  otp String?
  authUrl String?
  // user can add it later by defualt empty
  bio String @default("")
  isVerified Boolean @default(false)
  
  subscribers  Subscription[]  @relation("channel")
  subscribedChannels Subscription[] @relation("subscriber")  


  comments Comment[]
  likes Like[]
  playlists Playlist[]
  tweets Tweet[]

  @@index([userName])
  @@index([email])
}

model Video {
  id String @id @default(uuid())
  videoFile String 
  videoPublicId String 
  thumbnailPublicId String
  thumbnail String 
  title String 
  description String 
  ownerId String 
  
  owner User @relation(fields: [ownerId],references: [id])
  duration Int 
  
  
  views Int @default(0)
  isPublished Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  viewedBy WatchHistory[]
  likes Like[]
  comments Comment[]
  
  playListVideos PlaylistVideo[]

  @@index([title])
  @@index([ownerId])
  @@index([isPublished])
  

}
model WatchHistory {
  id String @id @default(uuid())
  viewerId String 
  videoId String 
  watchedAt DateTime @default(now())
  watchedTill Int @default(0) 

  updatedAt DateTime @updatedAt
  

  video Video @relation(fields: [videoId],references: [id],onDelete: Cascade)
  viewer User @relation(fields: [viewerId],references: [id],onDelete: Cascade)
  
  @@unique([videoId,viewerId])
  @@index([viewerId])
  @@index([watchedAt])


}

model Subscription {
  
  subscriberId String  
  subscriber User @relation("subscriber",fields: [subscriberId],references: [id],onDelete: Cascade) 
  
  channelId String 
  channel User @relation("channel",fields: [channelId],references: [id],onDelete: Cascade)
  createdAt DateTime @default(now())



 
 // as subscriber id is first in primary key dont need seprate index for ir
  @@id([subscriberId,channelId])
  
  @@index([channelId])
  
}

model Comment {
  id  String @id @default(uuid())
  content String 

  ownerId String 
  owner User @relation(fields: [ownerId],references: [id],onDelete: Cascade)
 
  videoId String?
  video Video? @relation(fields: [videoId],references: [id],onDelete: Cascade) 
 
  tweetId String?
  tweet Tweet? @relation(fields: [tweetId],references: [id],onDelete: Cascade)
  
  parentCommentId String? 
  parent Comment? @relation("CommentToComment",fields: [parentCommentId],references: [id],onDelete: Cascade)
  replies Comment[] @relation("CommentToComment")
  likes Like[]

  
  createdAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([videoId])
  @@index([tweetId])
  @@index([parentCommentId])
  @@index([ownerId])

}


model Like{
  id String @id @default(uuid())
  
  ownerId String 
  owner User @relation(fields: [ownerId],references: [id],onDelete: Cascade)
  videoId String? 
  video Video? @relation(fields: [videoId],references: [id],onDelete: Cascade)

  tweetId String?
  tweet Tweet? @relation(fields: [tweetId],references: [id],onDelete: Cascade)
  commentId String? 
  comment Comment? @relation(fields: [commentId],references: [id],onDelete: Cascade)

  @@unique([ownerId,videoId])
  @@unique([ownerId,tweetId])
  @@unique([ownerId,commentId])

  @@index([tweetId])
  @@index([commentId])
  @@index([videoId])

}

model Playlist{
  id String @id @default(uuid())
  name String
  description String
  
  ownerId String 
  owner User @relation(fields: [ownerId],references: [id],onDelete: Cascade)
  
  videos PlaylistVideo[]

  createdAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])

}

model PlaylistVideo{
id String @id @default(uuid())
videoId String
playlistId String 
position Int 
description String
isPublic Boolean @default(true)

createdAt DateTime @default(now())
updatedAt DateTime @updatedAt

video Video @relation(fields: [videoId],references: [id],onDelete: Cascade)
playlist Playlist @relation(fields: [playlistId],references: [id],onDelete: Cascade)

@@unique([playlistId,videoId])
@@index([playlistId])
@@index([videoId])
}

model Tweet{
  id String @id @default(uuid())
  
  ownerId String 
  owner User  @relation(fields: [ownerId],references: [id],onDelete: Cascade)
  
  content String 
  multimedia TweetMedia[]

  createdAt  DateTime @default(now())
  updatedAt DateTime @updatedAt
  likes Like[]
  comments Comment[]

  @@index([ownerId])
  @@index([createdAt])
}


model TweetMedia{
  id String @id @default(uuid())
  url String 
  altText String? 
  publicId String?
  tweetId String
  tweet Tweet @relation(fields: [tweetId],references: [id],onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([tweetId])
}


